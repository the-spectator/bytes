<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.3">Jekyll</generator><link href="the-spectator.github.io/feed.xml" rel="self" type="application/atom+xml" /><link href="the-spectator.github.io/" rel="alternate" type="text/html" /><updated>2024-04-28T14:11:07+05:30</updated><id>the-spectator.github.io/feed.xml</id><title type="html">Bytes</title><subtitle>Byte size blogs to share my experiences.</subtitle><entry><title type="html">Reverse Find in Ruby</title><link href="the-spectator.github.io/ruby/2024/04/28/reverse_find.html" rel="alternate" type="text/html" title="Reverse Find in Ruby" /><published>2024-04-28T16:15:06+05:30</published><updated>2024-04-28T16:15:06+05:30</updated><id>the-spectator.github.io/ruby/2024/04/28/reverse_find</id><content type="html" xml:base="the-spectator.github.io/ruby/2024/04/28/reverse_find.html"><![CDATA[<p>One of the things that sets Ruby apart from other programming languages is its impressive set of built-in features.
One of my favourite method is <a href="https://ruby-doc.org/3.3.0/Enumerable.html#method-i-detect"><code class="language-plaintext highlighter-rouge">Enumerable#detect</code></a>.
It returns the first element for which the block yields a truthy value and stops searching upon the first hit.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"prime"</span>
<span class="n">arr</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="mi">10</span><span class="p">).</span><span class="nf">to_a</span>
<span class="n">arr</span><span class="p">.</span><span class="nf">detect</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="no">Prime</span><span class="p">.</span><span class="nf">prime?</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">}</span> <span class="c1">#=&gt; 2</span>
</code></pre></div></div>

<p>Okay, letâ€™s spice it up! How do we find last matching element? A possible solution could be to filter the whole array using <a href="https://ruby-doc.org/3.3.0/Enumerable.html#method-i-select"><code class="language-plaintext highlighter-rouge">Enumerable#filter</code></a>, and use the last match.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"prime"</span>
<span class="n">arr</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="mi">10</span><span class="p">).</span><span class="nf">to_a</span>
<span class="n">arr</span><span class="p">.</span><span class="nf">filter</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="no">Prime</span><span class="p">.</span><span class="nf">prime?</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">}.</span><span class="nf">last</span> <span class="c1">#=&gt; 7</span>
</code></pre></div></div>

<p>However, this approach means traversing the entire array just to get that final match and discarding rest of the matches.</p>

<h3>Ruby to Rescue</h3>

<p>Ruby provides another awesome method <a href="https://ruby-doc.org/3.3.0/Enumerable.html#method-i-reverse_each"><code class="language-plaintext highlighter-rouge">Enumerable#reverse_each</code></a>, it allows to gracefully traverse an array in reverse order without mutating the original array.</p>

<p>Combining it with <code class="language-plaintext highlighter-rouge">Array#detect</code>, we now have an optimized solution where we can find the last matching element without traversing the full array, making it doubly awesome.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"prime"</span>
<span class="n">arr</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="mi">10</span><span class="p">).</span><span class="nf">to_a</span>
<span class="n">arr</span><span class="p">.</span><span class="nf">reverse_each</span><span class="p">.</span><span class="nf">detect</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="no">Prime</span><span class="p">.</span><span class="nf">prime?</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">}</span>
</code></pre></div></div>

<h3>Wait! Ruby is actually more awesome!!</h3>

<p>Ruby provides a method that exactly matches our use case: <a href="https://ruby-doc.org/3.3.0/Array.html#method-i-rindex"><code class="language-plaintext highlighter-rouge">Array#rindex</code></a>.
This method returns the index of the last element for which the block returns a truthy value.</p>

<p>While similar to <code class="language-plaintext highlighter-rouge">Enumerable#detect</code>, there is a slight difference between the two: <code class="language-plaintext highlighter-rouge">Enumerable#detect</code> returns the matched element itself, whereas <code class="language-plaintext highlighter-rouge">Array#rindex</code> returns the index of that element.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"prime"</span>
<span class="n">arr</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="mi">10</span><span class="p">).</span><span class="nf">to_a</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">arr</span><span class="p">.</span><span class="nf">rindex</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="no">Prime</span><span class="p">.</span><span class="nf">prime?</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">}</span>
<span class="n">arr</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="c1">#=&gt; 7</span>
</code></pre></div></div>

<h3>Benchmark It!!</h3>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># frozen_string_literal: true</span>

<span class="nb">require</span> <span class="s2">"bundler/inline"</span>

<span class="n">gemfile</span> <span class="kp">true</span> <span class="k">do</span>
  <span class="n">source</span> <span class="s2">"https://rubygems.org"</span>

  <span class="n">gem</span> <span class="s2">"benchmark-ips"</span>
  <span class="n">gem</span> <span class="s2">"prime"</span>
<span class="k">end</span>

<span class="nb">require</span> <span class="s2">"benchmark/ips"</span>
<span class="nb">require</span> <span class="s2">"prime"</span>

<span class="no">ARR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="mi">100_000</span><span class="p">).</span><span class="nf">to_a</span>

<span class="no">Benchmark</span><span class="p">.</span><span class="nf">ips</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s2">"reverse_each.detect"</span><span class="p">)</span> <span class="p">{</span> <span class="no">ARR</span><span class="p">.</span><span class="nf">reverse_each</span><span class="p">.</span><span class="nf">detect</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="no">Prime</span><span class="p">.</span><span class="nf">prime?</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s2">"filter.last"</span><span class="p">)</span> <span class="p">{</span> <span class="no">ARR</span><span class="p">.</span><span class="nf">filter</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="no">Prime</span><span class="p">.</span><span class="nf">prime?</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">}.</span><span class="nf">last</span> <span class="p">}</span>
  <span class="n">x</span><span class="p">.</span><span class="nf">report</span><span class="p">(</span><span class="s2">"rindex"</span><span class="p">)</span> <span class="p">{</span> <span class="no">ARR</span><span class="p">[</span><span class="no">ARR</span><span class="p">.</span><span class="nf">rindex</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="no">Prime</span><span class="p">.</span><span class="nf">prime?</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">}]</span> <span class="p">}</span>

  <span class="n">x</span><span class="p">.</span><span class="nf">compare!</span>
<span class="k">end</span>

<span class="c1"># ruby 3.3.0 (2023-12-25 revision 5124f9ac75) +YJIT [arm64-darwin22]</span>
<span class="c1"># Warming up --------------------------------------</span>
<span class="c1">#  reverse_each.detect     7.306k i/100ms</span>
<span class="c1">#          filter.last     1.000 i/100ms</span>
<span class="c1">#               rindex     7.623k i/100ms</span>
<span class="c1"># Calculating -------------------------------------</span>
<span class="c1">#  reverse_each.detect     73.400k (Â± 1.2%) i/s -    372.606k in   5.077127s</span>
<span class="c1">#          filter.last      8.764 (Â± 0.0%) i/s -     44.000 in   5.025497s</span>
<span class="c1">#               rindex     76.693k (Â± 1.0%) i/s -    388.773k in   5.069692s</span>

<span class="c1"># Comparison:</span>
<span class="c1">#               rindex:    76693.4 i/s</span>
<span class="c1">#  reverse_each.detect:    73400.3 i/s - 1.04x  slower</span>
<span class="c1">#          filter.last:        8.8 i/s - 8750.82x  slower</span>
</code></pre></div></div>

<p>The results are in, and it looks like <code class="language-plaintext highlighter-rouge">Array#rindex</code> is the clear winner! While <code class="language-plaintext highlighter-rouge">reverse_each.detect</code> puts up a valiant effort, it falls just short of the mark. And as for <code class="language-plaintext highlighter-rouge">filter.last</code>, well, letâ€™s just say itâ€™s taking the scenic routeâ€¦ at a snailâ€™s pace.</p>]]></content><author><name></name></author><category term="ruby" /><summary type="html"><![CDATA[One of the things that sets Ruby apart from other programming languages is its impressive set of built-in features. One of my favourite method is Enumerable#detect. It returns the first element for which the block yields a truthy value and stops searching upon the first hit.]]></summary></entry></feed>